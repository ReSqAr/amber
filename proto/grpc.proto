syntax = "proto3";

import "google/protobuf/timestamp.proto";

package grpc;



message CurrentRepositoryMetadataRequest {}
message CurrentRepositoryMetadataResponse {
  string id = 1;
  string name = 2;
}

message RepositorySyncState {
    string repo_id = 1;
    optional uint64 last_file_index = 2;
    optional uint64 last_blob_index = 3;
    optional uint64 last_name_index = 4;
}

message File {
    uint64 uid = 1;
    string path = 2;
    optional string blob_id = 3;
    google.protobuf.Timestamp valid_from = 4;
}

message Blob {
    uint64 uid = 1;
    string repo_id = 2;
    string blob_id = 3;
    uint64 blob_size = 4;
    bool has_blob = 5;
    optional string path = 6;
    google.protobuf.Timestamp valid_from = 7;
}

message RepositoryName {
    uint64 uid = 1;
    string repo_id = 2;
    string name = 3;
    google.protobuf.Timestamp valid_from = 4;
}

message MergeRepositorySyncStatesResponse {}
message MergeFilesResponse {}
message MergeBlobsResponse {}
message MergeRepositoryNamesResponse {}

message UpdateLastIndicesRequest {}
message UpdateLastIndicesResponse {}

message LookupLastIndicesRequest {
    string repo_id = 1;
}
message LookupLastIndicesResponse {
    optional uint64 file = 1;
    optional uint64 blob = 2;
    optional uint64 name = 3;
}

message SelectRepositorySyncStatesRequest {}
message SelectFilesRequest {
    optional uint64 last_index = 1;
}
message SelectBlobsRequest {
    optional uint64 last_index = 1;
}
message SelectRepositoryNamesRequest {
    optional uint64 last_index = 1;
}

message RclonePathRequest {
    uint32 transfer_id = 1;
}
message RclonePathResponse {
    string path = 1;
}

message TransferItem {
    uint32 transfer_id = 1;
    string blob_id = 2;
    uint64 blob_size = 3;
    string path = 4;
}

message PrepareTransferResponse {
    uint64 count = 1;
}
message CreateTransferRequestRequest {
    uint32 transfer_id = 1;
    string repo_id = 2;
    repeated string paths = 3;
}
message CopiedTransferItem {
    uint32 transfer_id = 1;
    string blob_id = 2;
    uint64 blob_size = 3;
    string path = 4;
}
message FinaliseTransferResponse {
    uint64 count = 1;
}

message FlightdeckMessageRequest {}

message FlightdeckData {
    string key = 1;
    oneof value {
        string string = 2;
        uint64 u64 = 3;
        bool bool = 4;
    }
}

message FlightdeckObservation {
    string type_key = 1;
    optional string id = 2;
    google.protobuf.Timestamp timestamp = 3;
    bool is_terminal = 4;
    repeated FlightdeckData data = 5;
}

message FlightdeckMessage {
    string level = 1;
    FlightdeckObservation observation = 2;
}

service Grpc {
  rpc CurrentRepositoryMetadata (CurrentRepositoryMetadataRequest) returns (CurrentRepositoryMetadataResponse);
  rpc MergeRepositorySyncStates (stream RepositorySyncState) returns (MergeRepositorySyncStatesResponse);
  rpc MergeFiles (stream File) returns (MergeFilesResponse);
  rpc MergeBlobs (stream Blob) returns (MergeBlobsResponse);
  rpc MergeRepositoryNames (stream RepositoryName) returns (MergeRepositoryNamesResponse);
  rpc UpdateLastIndices (UpdateLastIndicesRequest) returns (UpdateLastIndicesResponse);

  rpc LookupLastIndices (LookupLastIndicesRequest) returns (LookupLastIndicesResponse);
  rpc SelectRepositorySyncStates (SelectRepositorySyncStatesRequest) returns (stream RepositorySyncState);
  rpc SelectFiles (SelectFilesRequest) returns (stream File);
  rpc SelectBlobs (SelectBlobsRequest) returns (stream Blob);
  rpc SelectRepositoryNames (SelectRepositoryNamesRequest) returns (stream RepositoryName);

  rpc RclonePath(RclonePathRequest) returns (RclonePathResponse);
  rpc PrepareTransfer(stream TransferItem) returns (PrepareTransferResponse);
  rpc CreateTransferRequest(CreateTransferRequestRequest) returns (stream TransferItem);
  rpc FinaliseTransfer(stream CopiedTransferItem) returns (FinaliseTransferResponse);

  rpc FlightdeckMessages(FlightdeckMessageRequest) returns (stream FlightdeckMessage);
}